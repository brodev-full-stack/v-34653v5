<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Document Generator</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    <!-- Marked.js for Markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked@12.0.2/marked.min.js"></script>
    <!-- Mermaid.js for diagrams -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.9.1/dist/mermaid.min.js"></script>
    <!-- html2canvas and jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background: #f1f5f9; /* slate-100 */
            color: #1f2937; /* gray-800 */
        }

        .ai-card {
            background: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease-in-out;
        }

        .prose h1, .prose h2, .prose h3 {
            color: #111827;
        }
        .prose p {
            color: #374151;
        }
        .prose ul, .prose ol {
            color: #374151;
        }
        .prose a {
            color: #2563eb;
        }
        .prose pre {
            background-color: #e5e7eb;
            color: #1f2937;
        }
        .prose table {
            border-collapse: collapse;
            width: 100%;
        }
        .prose th, .prose td {
            border: 1px solid #d1d5db;
            padding: 8px;
            text-align: left;
        }
        .prose th {
            background-color: #e5e7eb;
            color: #1f2937;
        }

        .fade-in-up {
            animation: fadeInUp 0.5s ease-out;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen p-4 bg-slate-100">

    <!-- Main AI Card -->
    <div class="ai-card w-full max-w-4xl p-8 rounded-3xl mx-auto my-auto flex flex-col items-center">
        <header class="text-center mb-10">
            <h1 class="text-4xl font-extralight text-gray-800">Hello, how can I help you?</h1>
        </header>

        <!-- Dropzone and File List -->
        <div id="dropzone" class="w-full mb-6 p-6 border-2 border-dashed border-gray-300 rounded-2xl text-center cursor-pointer transition-all duration-300 hover:border-blue-500 hover:bg-blue-50">
            <input type="file" id="file-upload" class="hidden" multiple accept=".txt, .md, .pdf" />
            <div class="flex flex-col items-center justify-center">
                <div class="h-8 w-8 text-gray-400" id="upload-icon-placeholder"></div>
                <p class="mt-2 text-sm text-gray-500">Arrastra y suelta archivos aquí, o haz clic para subir</p>
                <p class="text-xs text-gray-400">Archivos soportados: .txt, .md, .pdf</p>
            </div>
        </div>

        <!-- Uploaded Files List -->
        <div id="uploaded-files-container" class="w-full space-y-2 mb-6 max-h-48 overflow-y-auto hidden">
            <!-- Files will be dynamically added here -->
        </div>

        <!-- Prompt and Action Buttons -->
        <div class="w-full flex flex-col md:flex-row space-y-4 md:space-y-0 md:space-x-4 mb-6">
            <textarea
                id="prompt-input"
                class="flex-1 p-4 text-sm bg-white rounded-2xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors resize-none"
                rows="3"
                placeholder="Ej: Siguiendo la plantilla, crea un documento del modelo de dominio del proyecto para una aplicación de gestión de tareas."
            ></textarea>
            <div class="flex flex-col space-y-2">
                <button
                    id="generate-btn"
                    class="flex-1 flex items-center justify-center space-x-2 px-6 py-4 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-2xl shadow-lg transform hover:scale-105 transition-all duration-300 disabled:opacity-50 disabled:hover:scale-100 disabled:cursor-not-allowed"
                >
                    <div class="h-5 w-5" id="generate-icon-placeholder"></div>
                    <span id="generate-btn-text">Generar</span>
                </button>
                <button
                    id="download-btn"
                    class="flex-1 flex items-center justify-center space-x-2 px-6 py-4 bg-green-600 hover:bg-green-700 text-white font-bold rounded-2xl shadow-lg transform hover:scale-105 transition-all duration-300 disabled:opacity-50 disabled:hover:scale-100 disabled:cursor-not-allowed"
                    disabled
                >
                    <div class="h-5 w-5" id="download-icon-placeholder"></div>
                    <span id="download-btn-text">Descargar</span>
                </button>
            </div>
        </div>

        <!-- Document Preview Area -->
        <div id="document-content-container" class="w-full p-8 rounded-2xl bg-white shadow-inner hidden fade-in-up">
            <div id="document-content" class="prose max-w-none prose-h1:text-3xl prose-h2:text-2xl prose-h3:text-xl prose-p:text-base prose-p:leading-relaxed prose-li:text-base"></div>
        </div>
    </div>
    
    <!-- AI Status Notification -->
    <div id="ai-status-window" class="fixed bottom-4 left-1/2 -translate-x-1/2 p-4 rounded-xl shadow-2xl bg-blue-600 text-white opacity-0 transition-all duration-500 z-50 transform -translate-y-full">
        <div class="flex items-center space-x-3">
            <div class="h-5 w-5 animate-spin" id="ai-status-icon-placeholder"></div>
            <span id="ai-status-text" class="text-sm font-semibold"></span>
        </div>
    </div>

    <!-- The actual script logic is written in TypeScript and transpiled to JS -->
    <script type="text/javascript">
        "use strict";
        var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
            function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
            return new (P || (P = Promise))(function (resolve, reject) {
                function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
                function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
                function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
                step((generator = generator.apply(thisArg, _arguments || [])).next());
            });
        };
        document.addEventListener('DOMContentLoaded', () => {
            const promptInput = document.getElementById('prompt-input');
            const fileUpload = document.getElementById('file-upload');
            const dropzone = document.getElementById('dropzone');
            const generateBtn = document.getElementById('generate-btn');
            const downloadBtn = document.getElementById('download-btn');
            const documentContentDiv = document.getElementById('document-content');
            const documentContentContainer = document.getElementById('document-content-container');
            const uploadedFilesContainer = document.getElementById('uploaded-files-container');
            const aiStatusWindow = document.getElementById('ai-status-window');
            const aiStatusText = document.getElementById('ai-status-text');
            const aiStatusIconPlaceholder = document.getElementById('ai-status-icon-placeholder');
            const aiLoaderIcon = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-loader-2 animate-spin"><path d="M21 12a9 9 0 1 1-6.219-8.56"></path></svg>';
            let uploadedFiles = JSON.parse(localStorage.getItem('uploadedFiles')) || [];
            if (typeof pdfjsLib !== 'undefined') {
                pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js';
            }
            if (typeof mermaid !== 'undefined') {
                mermaid.initialize({ startOnLoad: false, theme: 'neutral' });
            }
            // Corrected setIcon function
            const setIcon = (elementId, iconName) => {
                const element = document.getElementById(elementId);
                if (element && lucide.icons[iconName]) {
                    element.innerHTML = lucide.icons[iconName].toSvg();
                }
            };
            setIcon('upload-icon-placeholder', 'FileUp');
            setIcon('generate-icon-placeholder', 'Wand2');
            setIcon('download-icon-placeholder', 'Download');
            const showAIStatus = (text) => {
                aiStatusText.textContent = text;
                aiStatusWindow.style.opacity = '1';
                aiStatusWindow.style.transform = 'translateY(0)';
                if (aiStatusIconPlaceholder)
                    aiStatusIconPlaceholder.innerHTML = aiLoaderIcon;
            };
            const hideAIStatus = () => {
                aiStatusWindow.style.opacity = '0';
                aiStatusWindow.style.transform = 'translateY(100%)';
            };
            const renderUploadedFiles = () => {
                uploadedFilesContainer.innerHTML = '';
                if (uploadedFiles.length === 0) {
                    uploadedFilesContainer.classList.add('hidden');
                    return;
                }
                uploadedFilesContainer.classList.remove('hidden');
                uploadedFiles.forEach((file, index) => {
                    const fileElement = document.createElement('div');
                    fileElement.className = 'flex items-center justify-between p-3 bg-white rounded-xl border border-gray-200 transition-colors hover:bg-gray-100 fade-in-up';
                    const fileIcon = lucide.icons['FileText'].toSvg();
                    const trashIcon = lucide.icons['Trash2'].toSvg();
                    fileElement.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <div class="h-5 w-5 text-green-500">${fileIcon}</div>
                        <span class="text-sm text-gray-700 truncate">${file.name}</span>
                    </div>
                    <button class="p-1 rounded-full text-gray-400 hover:text-red-600 transition-colors remove-file-btn" data-index="${index}">
                        <div class="h-4 w-4">${trashIcon}</div>
                    </button>
                `;
                    uploadedFilesContainer.appendChild(fileElement);
                });
                document.querySelectorAll('.remove-file-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const index = e.currentTarget.getAttribute('data-index');
                        uploadedFiles.splice(parseInt(index, 10), 1);
                        localStorage.setItem('uploadedFiles', JSON.stringify(uploadedFiles));
                        renderUploadedFiles();
                    });
                });
            };
            const processFiles = (files) => __awaiter(void 0, void 0, void 0, function* () {
                var _a;
                showAIStatus('Leyendo archivos...');
                const newFiles = [];
                for (const file of files) {
                    try {
                        let fileContent = '';
                        if (file.type === 'application/pdf') {
                            const typedarray = new Uint8Array(yield file.arrayBuffer());
                            const pdf = yield pdfjsLib.getDocument({ data: typedarray }).promise;
                            for (let i = 1; i <= pdf.numPages; i++) {
                                const page = yield pdf.getPage(i);
                                const textContent = yield page.getTextContent();
                                fileContent += textContent.items.map(item => item.str).join(' ');
                            }
                        }
                        else if (file.type === 'text/plain' || file.name.endsWith('.md')) {
                            fileContent = yield new Promise((resolve) => {
                                const reader = new FileReader();
                                reader.onload = (e) => resolve((_a = e.target) === null || _a === void 0 ? void 0 : _a.result);
                                reader.readAsText(file);
                            });
                        }
                        else {
                            console.error('Unsupported file type:', file.name);
                            continue;
                        }
                        newFiles.push({ name: file.name, content: fileContent });
                    }
                    catch (error) {
                        console.error('Error reading file:', file.name, error);
                    }
                }
                uploadedFiles.push(...newFiles);
                localStorage.setItem('uploadedFiles', JSON.stringify(uploadedFiles));
                renderUploadedFiles();
                hideAIStatus();
            });
            dropzone.addEventListener('click', () => fileUpload.click());
            dropzone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropzone.classList.add('border-blue-500', 'bg-blue-50');
            });
            dropzone.addEventListener('dragleave', () => {
                dropzone.classList.remove('border-blue-500', 'bg-blue-50');
            });
            dropzone.addEventListener('drop', (e) => {
                var _a;
                e.preventDefault();
                dropzone.classList.remove('border-blue-500', 'bg-blue-50');
                const files = ((_a = e.dataTransfer) === null || _a === void 0 ? void 0 : _a.files) || [];
                if (files.length > 0) {
                    void processFiles(files);
                }
            });
            fileUpload.addEventListener('change', (event) => {
                const files = event.target.files;
                if (files && files.length > 0) {
                    void processFiles(files);
                }
            });
            generateBtn.addEventListener('click', () => __awaiter(void 0, void 0, void 0, function* () {
                var _b, _c, _d, _e;
                const prompt = promptInput.value;
                const fullContext = uploadedFiles.map(f => f.content).join('\n\n---\n\n');
                if (!prompt && !fullContext) {
                    alert('Please provide an instruction or upload context documents.');
                    return;
                }
                generateBtn.disabled = true;
                downloadBtn.disabled = true;
                document.getElementById('generate-btn-text').textContent = 'Generando...';
                document.getElementById('generate-icon-placeholder').innerHTML = aiLoaderIcon;
                documentContentContainer.classList.add('hidden');
                const instruction = `Please generate a project domain model document based on the following instructions:\n\n${prompt}\n\nFormat the document using APA v7 rules. If diagrams (class, package, etc.) are requested, use the Mermaid format (wrapped in \`\`\`mermaid ... \`\`\`). Use standard Markdown for tables.`;
                const fullPrompt = fullContext ? `Using the following documents as context:\n\n${fullContext}\n\nBased on this context, please complete the following task:\n\n${instruction}` : instruction;
                try {
                    showAIStatus('Analizando contenido...');
                    const chatHistory = [{ role: "user", parts: [{ text: fullPrompt }] }];
                    const payload = { contents: chatHistory };
                    const apiKey = "";
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                    const response = yield fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) {
                        throw new Error(`API call failed with status: ${response.status}`);
                    }
                    const result = yield response.json();
                    let generatedText = "Sorry, I could not generate a document. Please try again with a different request.";
                    if (((_c = (_b = result.candidates) === null || _b === void 0 ? void 0 : _b[0]) === null || _c === void 0 ? void 0 : _c.content) && ((_e = (_d = result.candidates[0].content.parts) === null || _d === void 0 ? void 0 : _d[0]) === null || _e === void 0 ? void 0 : _e.text)) {
                        generatedText = result.candidates[0].content.parts[0].text;
                    }
                    const mermaidRegex = /```mermaid\n([\s\S]*?)\n```/g;
                    const processedText = generatedText.replace(mermaidRegex, (match, p1) => `<div class="mermaid">${p1}</div>`);
                    const htmlContent = marked.parse(processedText);
                    documentContentDiv.innerHTML = htmlContent;
                    documentContentContainer.classList.remove('hidden');
                    if (typeof mermaid !== 'undefined') {
                        mermaid.init(undefined, '.mermaid');
                    }
                }
                catch (error) {
                    console.error('Error generating document:', error);
                    documentContentDiv.innerHTML = `<p class="text-red-500">An error occurred. Please check the console for details: ${error.message}</p>`;
                    documentContentContainer.classList.remove('hidden');
                }
                finally {
                    generateBtn.disabled = false;
                    downloadBtn.disabled = false;
                    document.getElementById('generate-btn-text').textContent = 'Generar';
                    setIcon('generate-icon-placeholder', 'Wand2');
                    hideAIStatus();
                }
            }));
            downloadBtn.addEventListener('click', () => __awaiter(void 0, void 0, void 0, function* () {
                if (documentContentContainer.classList.contains('hidden'))
                    return;
                downloadBtn.disabled = true;
                document.getElementById('download-btn-text').textContent = 'Creando PDF...';
                document.getElementById('download-icon-placeholder').innerHTML = aiLoaderIcon;
                try {
                    const docElement = document.getElementById('document-content-container');
                    const canvas = yield html2canvas(docElement, {
                        scale: 2,
                        useCORS: true,
                        backgroundColor: '#f3f4f6'
                    });
                    const imgData = canvas.toDataURL('image/png');
                    const pdf = new jspdf.jsPDF({
                        orientation: 'p',
                        unit: 'mm',
                        format: 'a4'
                    });
                    const imgWidth = 210;
                    const pageHeight = 295;
                    const imgHeight = canvas.height * imgWidth / canvas.width;
                    let heightLeft = imgHeight;
                    let position = 0;
                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                    while (heightLeft >= 0) {
                        position = heightLeft - imgHeight;
                        pdf.addPage();
                        pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                        heightLeft -= pageHeight;
                    }
                    pdf.save('documento_generado.pdf');
                }
                catch (error) {
                    console.error('Error creating PDF:', error);
                    alert('An error occurred while creating the PDF. Please check the console.');
                }
                finally {
                    downloadBtn.disabled = false;
                    document.getElementById('download-btn-text').textContent = 'Descargar';
                    setIcon('download-icon-placeholder', 'Download');
                }
            }));
            renderUploadedFiles();
        });
    </script>
</body>
</html>


